/*
 * Copyright 2018 Maxime Louet
 *
 * GitHub repository: https://github.com/maximelouet/blih-web
 */

var Guser=!1,Ghashedp=!1,actDisabled=!1,loaderTimeout=!1;const modal=new VanillaModal.default({loadClass:'modal-ok',onBeforeOpen:function(){infoHandle('hidden',!1)}});function updateConnectivity(){navigator.onLine?(document.getElementById('header').className='online',actDisabled=!1,document.documentElement.classList.remove('act-disabled')):(document.getElementById('header').className='offline',actDisabled=!0,document.documentElement.classList.add('act-disabled'))}window.addEventListener('online',updateConnectivity),window.addEventListener('offline',updateConnectivity),setTimeout(updateConnectivity,200);var decodeEntities=function(){var b=document.createElement('div');return function(c){return c&&'string'==typeof c&&(c=c.replace(/<script[^>]*>([\S\s]*?)<\/script>/gmi,''),c=c.replace(/<\/?\w(?:[^"'>]|"[^"]*"|'[^']*')*>/gmi,''),b.innerHTML=c,c=b.textContent,b.textContent=''),c}}();function htmlEntities(a){return(a+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}function escapeQuotes(a){return(a+'').replace(/\"/g,'&quot;').replace(/\'/g,'&apos;')}function escapeQuotesBack(a){return(a+'').replace(/\"/g,'&quot;').replace(/\'/g,'\\\'')}function switchModal(a,b,c,d){hideModal(a),setTimeout(function(){showModal(b,c,d)},300)}function showModal(a,b,c){var d=document.getElementById('modal-act');document.getElementById('modal-title').innerHTML=htmlEntities(b),!1==c?(d.className='',d.innerHTML=''):(d.className='shown',d.innerHTML=c),modal.open('#modal-'+a)}function hideModal(a){modal.close('#modal-'+a)}function checkRepoConfirm(a,b,c){c.disabled=escapeQuotes(a)!=escapeQuotes(b).valueOf()}function enableAct(){actDisabled||document.documentElement.classList.remove('act-disabled')}function loader(a){clearTimeout(loaderTimeout),a?(actDisabled=!0,document.documentElement.classList.add('loading'),document.documentElement.classList.add('act-disabled'),handleError(!1),loaderTimeout=setTimeout(function(){loader(!1)},15000)):(actDisabled=!1,document.documentElement.classList.remove('loading'),setTimeout(enableAct,200),clearTimeout(loaderTimeout))}function infoHandle(a,b){var c=document.getElementById('info-container');c.className='info-container '+a,b&&(c.innerHTML=b)}function handleError(a,b){a?infoHandle('bg-red',b):infoHandle('hidden',!1)}function handleSuccess(a,b){a?infoHandle('bg-green',b):infoHandle('hidden',!1)}function computeRepoList(a){var b='';for(repo in a)a.hasOwnProperty(repo)&&(repo=htmlEntities(a[repo]),b+='BITE'==repo.toUpperCase()?'<li class="bite">':'<li>',b+='<a href="#" onclick="event.preventDefault(); repoOpen(\''+escapeQuotesBack(repo)+'\');"><span>'+repo+'</span></a>',b+=repo?'<button class="btn" title="Delete this repository" onclick="event.preventDefault(); promptDelete(\''+escapeQuotesBack(repo)+'\');"><i class="i i-times"></i></button>':'<button class="btn" onclick="event.preventDefault(); repoOpen(\''+escapeQuotesBack(repo)+'\');"><i class="i i-times"></i></button>',b+='</li>\n');return b}function refreshRepolist(){repoList(function(a,b,c){if(a&&!c.hasOwnProperty('error')){var d=computeRepoList(c);document.getElementById('repolist').innerHTML=d}else handleError(!0,'An error occured.');loader(!1)})}function repoList(a){retrieve('repolist',!1,!1,a)}function repoGetAcl(a,b){retrieve('repogetacl',a,!1,b)}function repoGetInfo(a,b){retrieve('repogetinfo',a,!1,b)}function repoDelete(a){retrieve('repodel',a,!1,function(b,c,d){b&&d.hasOwnProperty('message')&&'Repository deleted'==d.message?(hideModal('repo-delete'),setTimeout(function(){handleSuccess(!0,'The repository <strong>'+htmlEntities(a)+'</strong> has been deleted.')},100),refreshRepolist()):handleError(!0,'An error occured while trying to delete the repository.'),loader(!1)})}function retrieve(a,b,c,d){loader(!0);var f={user:Guser},g=new jsSHA('SHA-512','TEXT');g.setHMACKey(Ghashedp,'TEXT'),g.update(Guser),!1!=c&&(f.data=c,g.update(JSON.stringify(c,null,4))),f.signature=g.getHMAC('HEX'),!1==b&&(b='kappa');var h='resource='+encodeURIComponent(b)+'&signed_data='+encodeURIComponent(JSON.stringify(f)),j=new XMLHttpRequest;j.onreadystatechange=function(){if(4==j.readyState&&d&&'function'==typeof d){var k=!1,l=j.responseText;if(200==j.status||404==j.status){var m=JSON.parse(l);m.hasOwnProperty('ERROR')||(k=!0,l=m)}d(k,j.status,l)}},j.open('POST','/api/'+a),j.setRequestHeader('Content-Type','application/x-www-form-urlencoded; charset=utf-8'),j.send(h)}function promptDelete(a){document.getElementById('repo-delete-confirmname').value='',showModal('repo-delete',a,'<button class="btn bg-red" id="repo-delete-confirmbutton" onclick="event.preventDefault(); repoDelete(decodeEntities(document.getElementById(\'modal-title\').innerHTML));" disabled>Confirm</button>'),document.getElementById('repo-delete-confirmname').focus()}function handleSaveAcl(a){a&&handleSuccess(!0,'The specified ACLs have been applied.')}function repoOpen(a){loader(!0);var b=document.getElementById('repo-info'),c=document.getElementById('repo-info-acl-container');return a?void(b.innerHTML='Loading repository info...',c.innerHTML='Loading ACL...',showModal('repo-info',a,'<button disabled class="btn bg-green" id="save-acl" onclick="event.preventDefault(); repoSetAllAcl(decodeEntities(document.getElementById(\'modal-title\').innerHTML), \'repo-info-acl\', handleSaveAcl);"><i class="i i-refresh"></i> Save ACLs</button><button class="btn bg-red" title="You will be prompted for a confirmation" onclick="event.preventDefault(); hideModal(\'repo-info\'); setTimeout(function(){promptDelete(\''+escapeQuotesBack(a)+'\');}, 200);"><i class="i i-trash"></i> Delete</button>'),c.innerHTML='<p>ACLs <button class="btn acl-add bg-green" onclick="event.preventDefault(); aclAdd(\'repo-info-acl\', \'\', \'\', true);" title="Add an ACL"> + </button></p><ul id="repo-info-acl" class="acl-list" data-aclnb="0" data-acltorem=""><span>Loading...</span></ul>',repoGetInfo(a,function(d,f,g){if(d&&g.message.hasOwnProperty('creation_time')&&g.message.hasOwnProperty('uuid')){var h=new Date(1e3*parseInt(g.message.creation_time));b.innerHTML='<b>Created</b>: '+h.getDate()+' '+h.toLocaleString('en-us',{month:'long'}).toLowerCase()+' '+h.getFullYear()+'<br><b>UUID</b>: '+g.message.uuid}else handleError(!0,'An error occured')}),repoGetAcl(a,function(d,f,g){if(d){if(c.innerHTML='<p>ACLs <button class="btn acl-add bg-green" onclick="event.preventDefault(); aclAdd(\'repo-info-acl\', \'\', \'\', true);"> + </button></p><ul id="repo-info-acl" class="acl-list" data-aclnb="0" data-acltorem=""><span>Loading</span></ul>',g.hasOwnProperty('error'))document.getElementById('repo-info-acl').innerHTML='<span>('+g.error+')</span>';else for(key in g)g.hasOwnProperty(key)&&aclAdd('repo-info-acl',key,g[key],!1);loader(!1)}else handleApiError(f,g)})):(b.innerHTML='This repository has an empty name, we can\'t access their data through BLIH\'s API.',c.innerHTML='',showModal('repo-info','(no name)','<button disabled class="btn bg-green" id="save-acl" onclick="event.preventDefault();"><i class="i i-refresh"></i> Save ACLs</button><button class="btn bg-red" disabled onclick="event.preventDefault();"><i class="i i-trash"></i> Delete</button>'),void loader(!1))}function repoCreate(a,b){if(!a)return void handleError(!0,'The name cannot be empty!');if(84<a.length)return void handleError(!0,'The name cannot exceed 84 characters!');retrieve('repocreate',!1,{name:a,type:'git'},function(d,f,g){d?repoSetAllAcl(a,b,function(h){h&&(refreshRepolist(),hideModal('repo-create'),handleSuccess(!0,'The repository <strong>'+htmlEntities(a)+'</strong> has been created with the specified ACLs.'))}):(handleApiError(f,g),loader(!1))})}function handleApiError(a,b){if(loader(!1),0==a)handleError(!0,'An error occured while connecting to the server.');else try{b=JSON.parse(b),b.hasOwnProperty('error')?handleError(!0,b.error):b.hasOwnProperty('message')?handleError(!0,b.message):handleError(!0,'An unknown error has occured.')}catch(c){console.log(Error('RIP RIP RIP RIP')),handleError(!0,'An unknown error has occured.')}}function getFormAcl(a){for(var b=document.getElementsByName(a+'-perm'),c=[],d=0;d<b.length;d++)b[d].checked&&c.push(b[d].value);return c.join('')}function getDOM(a){var b=new XMLHttpRequest;b.onreadystatechange=function(){4==b.readyState&&200==b.status?(document.getElementById('logged-in-dom').innerHTML=b.responseText,a()):4==b.readyState&&handleError(!0,'An unknown error occured.')},b.open('GET','/dom'),b.send()}function getRealUser(a){return a=a.trim(),a.endsWith('@epitech.eu')||(a+='@epitech.eu'),a}function login(){if(!actDisabled){loader(!0),handleError(!1);var a=document.getElementById('login-user').value,b=document.getElementById('login-pass').value;if(5>a.length||5>b.length)return handleError(!0,'Invalid username/password.'),void loader(!1);var c=new jsSHA('SHA-512','TEXT');c.update(b),Guser=getRealUser(a),Ghashedp=c.getHash('HEX'),repoList(function(d,f,g){if(d&&!g.hasOwnProperty('error')&&!g.hasOwnProperty('ERROR'))getDOM(function(){document.getElementById('logged-in-user').innerHTML=htmlEntities(Guser),document.body.classList.add('logged-in');var j=computeRepoList(g);document.getElementById('repolist').innerHTML=j,document.body.scrollTop=0,document.documentElement.scrollTop=0});else{Guser=!1,Ghashedp=!1;try{var h=JSON.parse(g);h.hasOwnProperty('ERROR')?handleError(!0,h.ERROR):h.hasOwnProperty('error')&&('Bad token'==h.error?handleError(!0,'Invalid username/password.'):handleError(!0,h.error))}catch(j){handleError(!0,'An unknown error has occured.')}}loader(!1)})}}function resetSaveAcl(){var a=document.getElementById('save-acl');a&&(a.disabled=!1),handleError(!1,!1)}function aclAdd(a,b,c,d){var f=document.getElementById(a);if(!(7<parseInt(f.dataset.aclnb)+1)){0==parseInt(f.dataset.aclnb)&&(f.innerHTML='');var g=document.createElement('li');d&&g.classList.add('draft');var h=document.createElement('input');h.type='text',d?'repo-create-acl'!=a&&(document.getElementById('save-acl').disabled=!1):h.disabled=!0,b?(h.placeholder=b,h.value=b):h.placeholder='User',h.maxlength=84;var j=document.createElement('span');j.className='acl-rights';var k=document.createElement('label'),l=document.createElement('label'),m=document.createElement('label');k.onselectstart=function(){return!1},l.onselectstart=function(){return!1},m.onselectstart=function(){return!1};var n=document.createElement('span'),o=document.createElement('span'),p=document.createElement('span'),q=document.createElement('input'),s=document.createElement('input'),t=document.createElement('input');q.type='checkbox',s.type='checkbox',t.type='checkbox',q.value='r',s.value='w',t.value='a',q.onclick=checkboxToggleHandler,s.onclick=checkboxToggleHandler,t.onclick=checkboxToggleHandler,'repo-create-acl'!=a&&(q.onchange=resetSaveAcl,s.onchange=resetSaveAcl,t.onchange=resetSaveAcl),c?(-1<c.indexOf('r')&&(q.checked=!0),-1<c.indexOf('w')&&(s.checked=!0),-1<c.indexOf('a')&&(t.checked=!0)):q.checked=!0;var u=document.createTextNode('r '),v=document.createTextNode('w '),w=document.createTextNode('a ');k.appendChild(q),l.appendChild(s),m.appendChild(t),n.appendChild(u),o.appendChild(v),p.appendChild(w),k.appendChild(n),l.appendChild(o),m.appendChild(p),j.appendChild(k),j.appendChild(l),j.appendChild(m);var x=document.createElement('button');x.className='btn acl-rem bg-red',x.onclick=function(z){z.stopPropagation(),aclRem(this.parentElement.parentElement,this.parentElement)};var y=document.createTextNode(' - ');x.appendChild(y),g.appendChild(h),g.appendChild(j),g.appendChild(x),f.appendChild(g),f.dataset.aclnb=parseInt(f.dataset.aclnb)+1,d&&h.focus()}}function aclRem(a,b){if(!(0>=parseInt(a.dataset.aclnb))){if(a.dataset.aclnb=parseInt(a.dataset.aclnb)-1,!b.classList.contains('draft')){var c=a.dataset.acltorem.split(',');','==c&&(c=''),c.push(b.children[0].value),a.dataset.acltorem=c.toString(),resetSaveAcl()}a.removeChild(b),0==parseInt(a.dataset.aclnb)&&(a.innerHTML='<span>(No ACLs)</span>')}}function getAclPerms(a){var b='';for(i=0;3>i;i++)!0==a.children[i].children[0].checked&&(b+=a.children[i].children[0].value);return b}function repoSetAllAcl(a,b,c){let d=new Promise((f,g)=>{loader(!0);var h=document.getElementById(b),j=parseInt(h.dataset.aclnb),k=h.dataset.acltorem.split(','),l=k.length-1;for(0==j&&0==l&&f(b),iaclset=0;iaclset<j;iaclset++){var m=iaclset;repoSetAcl(a,h.children[iaclset].children[0].value,getAclPerms(h.children[iaclset].children[1]),function(n,o,p){n&&(h.children[m].classList.remove('draft'),h.children[m].children[0].disabled=!0),n?m==j-1&&0==l&&f(b):g([o,p,b])})}for(iaclrem=1;iaclrem<=l;iaclrem++){var m=iaclrem;repoSetAcl(a,k[iaclrem],'',function(n,o,p){n?m==l&&f(b):g([o,p,b])})}});d.then(f=>{'repo-create-acl'!=f&&(document.getElementById('save-acl').disabled=!0),loader(!1),c(!0)}).catch(f=>{loader(!1),Array.isArray(f)?('repo-create-acl'==f[2]?(refreshRepolist(),hideModal('repo-create'),refreshRepolist()):document.getElementById('save-acl').disabled=!1,99==f[0]?handleError(!0,f[1]):handleApiError(f[0],f[1])):handleError(!0,f),c(!1)})}function repoSetAcl(a,b,c,d){if(!b||0==b.length)d(!1,99,'Invalid ACL user.');else if(b==Guser)d(!1,99,'Can\'t change acl for owner');else{retrieve('reposetacl',a,{acl:c,user:b},d)}}function showRepoCreate(){var a=document.getElementById('repo-create-acl');document.getElementById('repo-create-name').value='',a.innerHTML='<span>(No ACLs)</span>',a.dataset.aclnb=0,aclAdd('repo-create-acl','ramassage-tek','r',!0),showModal('repo-create','Create a repository','<button class="btn bg-green" onclick="event.preventDefault(); repoCreate(document.getElementById(\'repo-create-name\').value, \'repo-create-acl\');" id="repo-create-confirmbutton">Create <i class="i i-plus"></i></button>'),document.getElementById('repo-create-name').focus()}function checkboxToggleHandler(){var a=this.parentElement.parentElement.getElementsByTagName('input');!1===a[0].checked&&!1===a[1].checked&&!1===a[2].checked?this.parentElement.parentElement.parentElement.classList.add('for-deletion'):this.parentElement.parentElement.parentElement.classList.remove('for-deletion')}function attachCheckboxHandlers(a){for(var b=a.getElementsByTagName('input'),c=0,d=b.length;c<d;c++)'checkbox'===b[c].type&&(b[c].onclick=checkboxToggleHandler)}
